syntax = "proto3";

package proto.v1;

import "buf/validate/validate.proto";
import "google/protobuf/timestamp.proto";

// https://buf.build/bufbuild/protovalidate/docs/main:buf.validate#buf.validate.Violation

message GreetMsg {
  string id = 1 [ (buf.validate.field).string.uuid = true ];
  string uri = 2 [ (buf.validate.field).string.uri = true ];
}

message Peer {
  string id = 1 [ (buf.validate.field).string.uuid = true ];
  string uri = 2 [ (buf.validate.field).string.uri = true ];
  uint64 counter = 3 [ (buf.validate.field).required = true ];

  google.protobuf.Timestamp lastseen = 4
      [ (buf.validate.field).required = true ];
}

message GossipMsg {
  // these are values of the resp-er
  string id = 1 [ (buf.validate.field).string.uuid = true ];
  string uri = 2 [ (buf.validate.field).string.uri = true ];
  uint64 counter = 3 [ (buf.validate.field).required = true ];

  // we dont send our own timestamp, req-er will fill in with local clock
  repeated Peer peers = 4;
}

service ClusterService {
  rpc Greet(GreetMsg) returns (GreetMsg) {}
  rpc Gossip(GossipMsg) returns (GossipMsg) {}
}

// state replication

message ORSetAdd {
  string tag = 1;
  string key = 2 [ (buf.validate.field).required = true ];
}
message ORSetRemove { string tag = 1; } // could validate

message OrSet {
  repeated ORSetAdd adds = 1;
  repeated ORSetRemove removes = 2;
}

message ReplReq {
  string id = 1 [ (buf.validate.field).string.uuid = true ];
  map<string, uint64> vector = 2;
}

message ReplResp {
  string id = 1 [ (buf.validate.field).string.uuid = true ];
  map<string, uint64> vector = 3;
  OrSet orset = 2;
}

service StateService {
  rpc Replicate(ReplReq) returns (ReplResp) {}
}